---
slug: "/blog/pill_counter"
date: "2023-07-10"
title: "Pill Count"
featuredImage: ../images/
tags: ["project"]
---

Automated pill counters are typically used at large volume pharmacies that can save time counting medication. The biggest factor to consider is the cost of such devices. They are expensive to buy and expensive to maintain. There are two common pill counters on the market. They are the Kirby Lester and Eyecon pill counter. They both work in different ways. 
The Kirby Lester counter works by shaking a bottle of pills or capsules through a funnel that has sensors on the circumference that detect pills falling through the cylinder. You have to shake the pills and let through fall through the funnel at a moderate pace so that the sensors dont get overwhelmed and miscount. I think that the device is pretty low powered and runs on a basic microcontroller. I think that it has a series of lasers or some kind of proximity sensors that increment a counter upon deflection on light by the pills. It costs around $10k+ and more for the newer models. The Eyecon seems to be a bit more high tech. It uses computer vision and a camera fixed on an arm that looks down on a platter and count the number pills on the platter. According to the specs, it counts up to 5 times a second. Both models cover the two methods of counting pills. There are also large high tech machines that have robots and take up a room that manage and dispense the correct amount of medication but those are only economical for large hospitals and large volume pharmacies in populated regions. There are also machines that can be calibrated for counting a specific sized and type of medication really efficiently but you would need to recalibrate for different medications.

The two popular models cover the two most common methods of pill counting for other similar products on the market. The Eyecon also costs $10k+ per machine upfront. The more expensive and newer models of both of these methods work similarly but have additional features such as pharmacy software integration and barcode scanning to verify that the correct medication is dispensed. Each method of pill counting has its pros and cons. Both are much faster than counting by hand and both have 99% accuracy assuming you are using them correctly. The Kirby Lester suffers in the fact that you need to shake the bottle of medication over the funnel at a moderate pace which can be tiresome for your wrist. Also if you make a mistake and go too fast, it will throw an error telling you that you are pouring too fast and you'll have to restart. Additionally, it will not work for some weird rare pills like super translucent pills or some weird shapes like tablets with a hole in the middle, some split colered capsules, or some speckled colored pills. The Eyecon suffers from the fact that you have to make sure that none of the pills clumped or overlapping or else the camera will miscount. Both are costly. Not every small or even large pharmacy has automated pill counters. Replacement parts are expensive and repair tickets are also expensive and takes time. The challenge was to see if I could come up with a cheaper pill counter alternative that I could build with off the counter materials. Recreating something like the Kirby Lester was off the table because one, that would involve a lot of PCB, microcontroller work and iterating upon mechanical parts which I wasn't willing to invest in. Something that works like the Eyecon would be ideal. 

The application is Electron based with the intention of running on a Windows PC. It connects to a standard USB camera which was prototyped with T-slots. The application runs tensorflow inference on the video feed counting the pills. The application can save photos of counts when necessary. 

The most clear way to tackle detection would clearly be deep learning, but I tried various other simple ideas that end up not working. My first thought was to use a combination of segmentation and area. When you count pills, you're counting the a bunch of the same thing, so if can identify 1 of the item that you are trying to count, then take the area and divide over that 1 item and ideally, you'd get the number of items you'd get. There are serious problems to this approach. First, this works reasonably well with round or oval pills assuming they are spread apart. But if they are clumped, then segmentation gets more inaccurate. I noticed that the camera makes clumped objects seem smaller that if they were not clumped. Then there is the probelm with the fact that the camera is a point. Pills that are away from the direct perpendicular of where its pointed at will be distorted and get larger. When the tray gets all dusty, segmentation gets bad. I also couldn't figure out how to segment capsules. Several deep learning object detection models were experimented with. That was best way to detect such large variations of pills. Pills can be tablets or capsules. They can have different colors, sizes. Some have patterns, stripes. Most have words imprinted on them by the manufacturer. There are also weird ones that are semitranslucent, have ornamental decorations, or indented. I don't have an extremely indepth ML knowledge so I mostly used popular models rather than trying to make one myself. Several hundred images were gathered off the internet and through the roboflow public datasets. I took several hundred photos of a variety of pills myself when I was free. I hand labeled close to 1000 images on my own. Combined with some prelabeled public datasets and manipulating datasets through a combination of rotation, blurring, and saturation, I arrived at a dataset with >20k trainng image data. I've tried EfficientDet, MobileNet, Yolov5, and a couple others. I settled on using the yolov5s and yolov5m models after trying them out. I felt that the EfficientDet and MobileNet were not as accurate detecting small pills as was yolov5 versions. Empirically, I noticed that the yolov5 struggled more with variations such as lighting in a room or color saturation than the others that I tried. The most limiting factor that I had were the hardware considerations. The computer that I planned on running the appplication was more of a mid range PC with a low end GPU so any big model made the framerate too low. The small models had a lower accuracy than the larger ones. I aimed to match the >= 5fps detection of the Eyecon. Accuracywise, I would be happy to achieve >95% accuracy. 

The biggest bottleneck is the object detection inference. Unless I find a better method of pill counting that is faster and more efficient, I'm sticking with deep learning for pill detection. Something that I am uncertain about is whether or not having the application be an Electron application worsens its performance since it's basically like a chrome browser. One thing for sure that would improve the efficiency would be if I ran the inference on specialized hardware like a FPGA and then use a shared buffer to communicate the location of the pill detections. Or, I could just use a better gpu. 




